<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMVCS Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>MMVCS Dashboard</h1>
        </header>
        
        <main class="dashboard-main">
            <div class="widgets-grid" id="widgets-container">
                <div class="widget-container full-width welcome-widget">
                    <h3>Welcome Dashboard</h3>
                    <div class="widget-frame" id="widget-0">
                        <div class="loading">Setting up authentication...</div>
                    </div>
                </div>

                <div class="widget-container full-width">
                    <h3>Sales Comparison This Year vs. Last Year</h3>
                    <div class="widget-frame" id="widget-1">
                        <div class="loading">Setting up authentication...</div>
                    </div>
                </div>

                <div class="widget-container full-width">
                    <h3>Sales Chart by Month</h3>
                    <div class="widget-frame" id="widget-2">
                        <div class="loading">Setting up authentication...</div>
                    </div>
                </div>

                <div class="widget-container">
                    <h3>Destination Mix - Current Year</h3>
                    <div class="widget-frame" id="widget-3">
                        <div class="loading">Setting up authentication...</div>
                    </div>
                </div>

                <div class="widget-container">
                    <h3>Destination Mix - Last Year</h3>
                    <div class="widget-frame" id="widget-4">
                        <div class="loading">Setting up authentication...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Process authentication IMMEDIATELY, before DOMContentLoaded
        const urlParams = new URLSearchParams(window.location.search);
        const authParam = urlParams.get('auth');
        
        if (authParam) {
            try {
                // Decode credentials from URL
                const decoded = atob(decodeURIComponent(authParam));
                const [username, password] = decoded.split(':');
                
                if (username && password) {
                    // Store credentials immediately
                    localStorage.setItem('mmvcs_user', username);
                    localStorage.setItem('mmvcs_pass', password);
                    sessionStorage.setItem('mmvcs_user', username);
                    sessionStorage.setItem('mmvcs_pass', password);
                    
                    console.log('Credentials stored immediately for:', username);
                    
                    // Clean URL to remove credentials
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } catch (error) {
                console.error('Error processing authentication:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const cacheVersion = Date.now(); // Force fresh loading
            const widgets = [
                { id: 'widget-0', src: `https://dashboard.mmvcs-sales.com/welcome-wrapper.html?v=${cacheVersion}` },
                { id: 'widget-1', src: `https://dashboard.mmvcs-sales.com/sales-comparison-wrapper.html?v=${cacheVersion}` },
                { id: 'widget-2', src: `https://dashboard.mmvcs-sales.com/sales-chart-wrapper.html?v=${cacheVersion}` },
                { id: 'widget-3', src: `https://dashboard.mmvcs-sales.com/destination-current-wrapper.html?v=${cacheVersion}` },
                { id: 'widget-4', src: `https://dashboard.mmvcs-sales.com/destination-last-wrapper.html?v=${cacheVersion}` }
            ];
            
            // Load widgets with credentials already stored
            if (authParam) {
                console.log('Loading wrapper widgets with stored credentials');
                
                widgets.forEach((widget, index) => {
                    setTimeout(() => {
                        loadWidget(widget.id, widget.src);
                    }, index * 500); // Load widgets faster since 3 are working
                });
                
                showSuccessMessage();
            } else {
                // No authentication - show error
                document.getElementById('widgets-container').innerHTML = 
                    '<div style="text-align: center; padding: 50px; color: #666;">No authentication provided</div>';
            }
        });

        function loadWidget(containerId, src) {
            const container = document.getElementById(containerId);
            console.log(`Loading widget: ${containerId} from ${src}`);
            
            container.innerHTML = `
                <iframe src="${src}" 
                        width="100%" height="600" frameborder="0" scrolling="auto">
                </iframe>
            `;
        }

        function showSuccessMessage() {
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; 
                padding: 15px; border-radius: 5px; z-index: 10000; max-width: 300px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            `;
            statusDiv.innerHTML = `
                ✅ <strong>Loading Widgets</strong><br>
                Credentials stored, loading wrappers...
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: white; cursor: pointer; font-size: 16px;">×</button>
            `;
            document.body.appendChild(statusDiv);
            
            setTimeout(() => {
                if (document.body.contains(statusDiv)) {
                    document.body.removeChild(statusDiv);
                }
            }, 8000);
        }
    </script>
</body>
</html>