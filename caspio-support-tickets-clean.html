<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Support Tickets</title>
<style>
body { 
    margin: 0; 
    padding: 0; 
    font-family: Arial, sans-serif; 
}
#caspio-container { 
    width: 100%; 
    height: 100vh; 
}
</style>
</head>
<body>
<div id="caspio-container">
    <!-- Caspio widget will be loaded after authentication check -->
</div>

<script>
var caspioContainer = document.getElementById('caspio-container');
var widgetLoaded = false;

function loadCaspioWidget() {
    if (widgetLoaded) return;
    widgetLoaded = true;
    
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = 'https://c0acv999.caspio.com/dp/01217000b3314ae88b7949d3bc8d/emb';
    script.onload = function() {
        setTimeout(monitorForLoginForms, 2000);
    };
    
    caspioContainer.appendChild(script);
}

function monitorForLoginForms() {
    var attempts = 0;
    var maxAttempts = 15;
    
    var monitorInterval = setInterval(function() {
        attempts++;
        
        var bodyText = document.body.innerText.toLowerCase();
        var needsAuth = bodyText.includes('sign in') || 
                       bodyText.includes('log in') || 
                       bodyText.includes('login required') ||
                       bodyText.includes('please login') ||
                       bodyText.includes('authentication required') ||
                       bodyText.includes('access denied');
        
        var forms = document.querySelectorAll('form');
        var loginFormFound = false;
        
        forms.forEach(function(form) {
            var hasUsernameField = form.querySelector('input[type="text"], input[name*="user"], input[name*="login"], input[name*="email"]');
            var hasPasswordField = form.querySelector('input[type="password"], input[name*="pass"]');
            
            if (hasUsernameField && hasPasswordField) {
                loginFormFound = true;
                
                var username = localStorage.getItem('mmvcs_user') || sessionStorage.getItem('mmvcs_user');
                var password = localStorage.getItem('mmvcs_pass') || sessionStorage.getItem('mmvcs_pass');
                
                if (username && password) {
                    fillLoginForm(form, username, password);
                }
            }
        });
        
        if (needsAuth && !loginFormFound && attempts > 5) {
            setTimeout(function() {
                location.reload();
            }, 1000);
            clearInterval(monitorInterval);
            return;
        }
        
        if (!needsAuth && !loginFormFound && attempts > 8) {
            var hasContent = bodyText.includes('support') || bodyText.includes('request') || bodyText.includes('form');
            if (hasContent) {
                clearInterval(monitorInterval);
            }
        }
        
        if (attempts >= maxAttempts) {
            clearInterval(monitorInterval);
        }
        
    }, 2000);
}

function fillLoginForm(form, username, password) {
    var usernameField = form.querySelector('input[type="text"], input[name*="user"], input[name*="login"], input[name*="email"]');
    var passwordField = form.querySelector('input[type="password"], input[name*="pass"]');
    var submitButton = form.querySelector('input[type="submit"], button[type="submit"], button');
    
    if (usernameField && passwordField) {
        usernameField.value = '';
        passwordField.value = '';
        
        setTimeout(function() {
            usernameField.value = username;
            passwordField.value = password;
            
            ['input', 'change', 'keyup', 'blur', 'focus'].forEach(function(eventType) {
                usernameField.dispatchEvent(new Event(eventType, {bubbles: true}));
                passwordField.dispatchEvent(new Event(eventType, {bubbles: true}));
            });
            
            setTimeout(function() {
                if (submitButton) {
                    submitButton.click();
                }
                
                setTimeout(function() {
                    if (form.submit) {
                        form.submit();
                    }
                }, 500);
                
            }, 300);
            
        }, 200);
    }
}

function checkForCredentials() {
    // Don't auto-load with stored credentials - wait for fresh authentication
    return false;
}

// Listen for authentication messages
window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'mmvcs_auth' && event.data.username) {
        localStorage.setItem('mmvcs_user', event.data.username);
        localStorage.setItem('mmvcs_pass', event.data.password);
        
        setTimeout(function() {
            loadCaspioWidget();
        }, 1000);
    }
});

// Wait for authentication message - don't auto-load
console.log('Support Tickets widget ready - waiting for authentication');
</script>
</body>
</html>