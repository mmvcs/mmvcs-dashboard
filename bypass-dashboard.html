<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMVCS Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>MMVCS Dashboard</h1>
        </header>
        
        <main class="dashboard-main">
            <div class="widgets-grid">
                <div class="widget-container full-width welcome-widget">
                    <h3></h3>
                    <div class="widget-frame" id="widget-0">
                        <!-- Widget will be loaded here after authentication -->
                    </div>
                </div>

                <div class="widget-container full-width">
                    <h3>Sales Comparison This Year vs. Last Year</h3>
                    <div class="widget-frame" id="widget-1">
                        <!-- Widget will be loaded here after authentication -->
                    </div>
                </div>

                <div class="widget-container full-width">
                    <h3>Sales Chart by Month</h3>
                    <div class="widget-frame" id="widget-2">
                        <!-- Widget will be loaded here after authentication -->
                    </div>
                </div>

                <div class="widget-container">
                    <h3>Destination Mix - Current Year</h3>
                    <div class="widget-frame" id="widget-3">
                        <!-- Widget will be loaded here after authentication -->
                    </div>
                </div>

                <div class="widget-container">
                    <h3>Destination Mix - Last Year</h3>
                    <div class="widget-frame" id="widget-4">
                        <!-- Widget will be loaded here after authentication -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Widget URLs and credentials storage
        const widgetUrls = [
            'https://c0acv999.caspio.com/dp/01217000f2c3610f806e481a9264/emb',
            'https://c0acv999.caspio.com/dp/01217000201cfed888f24342b18f/emb', 
            'https://c0acv999.caspio.com/dp/0121700013fadbf0a2db4aca8f73/emb',
            'https://c0acv999.caspio.com/dp/01217000564ddc00d2ab4c7aac4d/emb',
            'https://c0acv999.caspio.com/dp/01217000301880de360842d1adb1/emb'
        ];
        
        let authUsername = '';
        let authPassword = '';

        document.addEventListener('DOMContentLoaded', () => {
            // Check for authentication credentials in URL
            const urlParams = new URLSearchParams(window.location.search);
            const authParam = urlParams.get('auth');
            
            if (authParam) {
                try {
                    // Decode credentials from URL
                    const decoded = atob(decodeURIComponent(authParam));
                    const [username, password] = decoded.split(':');
                    
                    if (username && password) {
                        authUsername = username;
                        authPassword = password;
                        
                        // Store credentials globally for Caspio
                        localStorage.setItem('mmvcs_user', username);
                        localStorage.setItem('mmvcs_pass', password);
                        sessionStorage.setItem('mmvcs_user', username);
                        sessionStorage.setItem('mmvcs_password', password);
                        
                        // Clean URL to remove credentials
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        console.log('Starting pre-authenticated widget loading with:', username);
                        
                        // Show loading message
                        showAuthMessage('ðŸ” Pre-authenticating widgets...');
                        
                        // Load widgets with authentication already set up
                        setTimeout(() => {
                            loadAuthenticatedWidgets();
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Error processing authentication:', error);
                    loadWidgetsNormally();
                }
            } else {
                // No authentication - load widgets normally
                loadWidgetsNormally();
            }
        });

        function showAuthMessage(message) {
            const statusDiv = document.createElement('div');
            statusDiv.id = 'auth-status';
            statusDiv.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #2c3e50; color: white; padding: 30px; border-radius: 10px; 
                z-index: 10000; font-size: 18px; text-align: center;
                box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            `;
            statusDiv.innerHTML = message;
            document.body.appendChild(statusDiv);
        }

        function hideAuthMessage() {
            const statusDiv = document.getElementById('auth-status');
            if (statusDiv) {
                statusDiv.remove();
            }
        }

        function loadAuthenticatedWidgets() {
            console.log('Loading widgets with pre-authentication');
            
            // Set up Caspio authentication interception BEFORE loading any widgets
            interceptCaspioAuth();
            
            // Load each widget with a delay
            widgetUrls.forEach((url, index) => {
                setTimeout(() => {
                    loadWidget(index, url);
                }, index * 1000); // Stagger loading by 1 second each
            });
            
            // Hide loading message after all widgets start loading
            setTimeout(() => {
                hideAuthMessage();
                showSuccessMessage();
            }, widgetUrls.length * 1000 + 2000);
        }

        function loadWidgetsNormally() {
            console.log('Loading widgets without authentication');
            widgetUrls.forEach((url, index) => {
                loadWidget(index, url);
            });
        }

        function loadWidget(index, url) {
            console.log(`Loading widget ${index}: ${url}`);
            const container = document.getElementById(`widget-${index}`);
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = url;
            
            // Add error handling
            script.onerror = () => {
                console.log(`Failed to load widget ${index}`);
                container.innerHTML = '<p style="color: red;">Failed to load widget</p>';
            };
            
            container.appendChild(script);
        }

        function interceptCaspioAuth() {
            console.log('Setting up Caspio authentication interception');
            
            // Intercept iframe loads and pre-authenticate them
            const originalCreateElement = document.createElement;
            document.createElement = function(tagName) {
                const element = originalCreateElement.call(document, tagName);
                
                if (tagName.toLowerCase() === 'iframe') {
                    element.addEventListener('load', function() {
                        if (this.src && this.src.includes('caspio.com')) {
                            console.log('Caspio iframe loaded, attempting pre-auth');
                            setTimeout(() => {
                                authenticateIframe(this);
                            }, 500);
                        }
                    });
                }
                
                return element;
            };
            
            // Also watch for dynamically created iframes
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeName === 'IFRAME' && node.src && node.src.includes('caspio.com')) {
                                console.log('Dynamic Caspio iframe detected');
                                setTimeout(() => {
                                    authenticateIframe(node);
                                }, 500);
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.body, { childList: true, subtree: true });
        }

        function authenticateIframe(iframe) {
            try {
                console.log('Attempting to authenticate iframe:', iframe.src);
                
                // Try multiple times with different delays to catch the form when it appears
                const attemptTimes = [500, 1000, 1500, 2000, 2500, 3000];
                
                attemptTimes.forEach(delay => {
                    setTimeout(() => {
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            
                            if (iframeDoc) {
                                // Look for login form
                                const usernameField = iframeDoc.querySelector('input[type="text"], input[name*="user"], input[name*="login"]');
                                const passwordField = iframeDoc.querySelector('input[type="password"], input[name*="pass"]');
                                const submitButton = iframeDoc.querySelector('input[type="submit"], button[type="submit"], button');
                                
                                if (usernameField && passwordField && submitButton) {
                                    console.log(`Found login form at ${delay}ms, authenticating...`);
                                    
                                    // Fill the form
                                    usernameField.value = authUsername;
                                    passwordField.value = authPassword;
                                    
                                    // Trigger all possible events to make sure form recognizes the input
                                    ['input', 'change', 'keyup', 'keydown', 'blur', 'focus'].forEach(eventType => {
                                        usernameField.dispatchEvent(new Event(eventType, { bubbles: true }));
                                        passwordField.dispatchEvent(new Event(eventType, { bubbles: true }));
                                    });
                                    
                                    // Try multiple submission methods
                                    setTimeout(() => {
                                        // Method 1: Click the submit button
                                        submitButton.click();
                                        console.log('Clicked submit button');
                                        
                                        // Method 2: Submit the form directly
                                        const form = usernameField.closest('form');
                                        if (form) {
                                            form.submit();
                                            console.log('Submitted form directly');
                                        }
                                        
                                        // Method 3: Trigger Enter key on password field
                                        passwordField.dispatchEvent(new KeyboardEvent('keydown', {
                                            key: 'Enter',
                                            code: 'Enter',
                                            which: 13,
                                            keyCode: 13,
                                            bubbles: true
                                        }));
                                        
                                        // Method 4: Focus and click
                                        passwordField.focus();
                                        setTimeout(() => {
                                            submitButton.focus();
                                            submitButton.click();
                                        }, 100);
                                        
                                        console.log('Multiple submission methods attempted');
                                    }, 200);
                                }
                            }
                        } catch (crossOriginError) {
                            // Send credentials via postMessage for cross-origin iframes
                            iframe.contentWindow.postMessage({
                                type: 'caspio_pre_auth',
                                username: authUsername,
                                password: authPassword
                            }, '*');
                            console.log('Sent pre-auth credentials via postMessage');
                        }
                    }, delay);
                });
            } catch (error) {
                console.log('Error in iframe pre-authentication:', error);
            }
        }

        function showSuccessMessage() {
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; 
                padding: 15px; border-radius: 5px; z-index: 10000; max-width: 300px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            `;
            statusDiv.innerHTML = `
                âœ… <strong>Dashboard Loaded</strong><br>
                All widgets pre-authenticated
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: white; cursor: pointer; font-size: 16px;">Ã—</button>
            `;
            document.body.appendChild(statusDiv);
            
            setTimeout(() => {
                if (document.body.contains(statusDiv)) {
                    document.body.removeChild(statusDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>