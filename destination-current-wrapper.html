<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Destination Mix - Current Year</title>
<style>
body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
#container { width: 100%; height: 100vh; }
.waiting { text-align: center; padding: 50px; color: #666; }
</style>
</head>
<body>
<div id="container">
<div class="waiting">Waiting for authentication...</div>
</div>

<script>
var container = document.getElementById('container');
var loaded = false;

function loadWidget() {
    if (loaded) return;
    loaded = true;
    
    container.innerHTML = `
        <iframe src="https://c0acv999.caspio.com/dp/01217000564ddc00d2ab4c7aac4d" 
                width="100%" height="100%" frameborder="0" scrolling="auto"
                onload="authenticateIframe(this)">
        </iframe>
    `;
}

function authenticateIframe(iframe) {
    var username = localStorage.getItem('mmvcs_user');
    var password = localStorage.getItem('mmvcs_pass');
    
    if (!username || !password) {
        console.log('No credentials found in localStorage');
        return;
    }
    
    console.log('Starting authentication for iframe with user:', username);
    
    // Try multiple times with different delays
    var delays = [1000, 2000, 3000, 5000];
    
    delays.forEach(function(delay) {
        setTimeout(function() {
            try {
                var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                console.log('Trying iframe authentication at delay:', delay);
                
                var forms = iframeDoc.querySelectorAll('form');
                console.log('Found', forms.length, 'forms in iframe');
                
                forms.forEach(function(form, index) {
                    var userField = form.querySelector('input[type="text"], input[name*="user"], input[name*="login"], input[placeholder*="user"], input[placeholder*="User"]');
                    var passField = form.querySelector('input[type="password"]');
                    var submitBtn = form.querySelector('input[type="submit"], button[type="submit"], button, input[value*="Login"], input[value*="login"]');
                    
                    console.log('Form', index, '- User field:', !!userField, 'Pass field:', !!passField, 'Submit:', !!submitBtn);
                    
                    if (userField && passField) {
                        userField.value = username;
                        passField.value = password;
                        
                        // Trigger change events
                        userField.dispatchEvent(new Event('change', { bubbles: true }));
                        passField.dispatchEvent(new Event('change', { bubbles: true }));
                        
                        console.log('Filled form', index, 'with credentials');
                        
                        setTimeout(function() {
                            if (submitBtn) {
                                submitBtn.click();
                                console.log('Clicked submit button for form', index);
                            } else {
                                // Try submitting the form directly
                                form.submit();
                                console.log('Submitted form', index, 'directly');
                            }
                        }, 300);
                    }
                });
            } catch (e) {
                console.log('Cross-origin iframe access blocked at delay', delay, '- using postMessage');
                iframe.contentWindow.postMessage({
                    type: 'mmvcs_auth',
                    username: username,
                    password: password
                }, '*');
            }
        }, delay);
    });
}

// Check for credentials every 3 seconds
setInterval(function() {
    var username = localStorage.getItem('mmvcs_user');
    if (username && !loaded) {
        loadWidget();
    }
}, 3000);

// Initial check
setTimeout(function() {
    var username = localStorage.getItem('mmvcs_user');
    if (username) loadWidget();
}, 1000);
</script>
</body>
</html>