<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sales Comparison</title>
<style>
body { 
    margin: 0; 
    padding: 0; 
    font-family: Arial, sans-serif; 
}
#caspio-container { 
    width: 100%; 
    height: 100vh; 
}
</style>
</head>
<body>
<div id="caspio-container">
    <script type="text/javascript" src="https://c0acv999.caspio.com/dp/01217000201cfed888f24342b18f/emb"></script>
</div>

<script>
function checkForCredentials() {
    var username = '';
    var password = '';
    var found = false;
    
    try {
        var localUser = localStorage.getItem('mmvcs_user');
        var localPass = localStorage.getItem('mmvcs_pass');
        if (localUser && localPass) {
            username = localUser;
            password = localPass;
            found = true;
        }
    } catch (e) {}
    
    if (!found) {
        try {
            var sessionUser = sessionStorage.getItem('mmvcs_user');
            var sessionPass = sessionStorage.getItem('mmvcs_pass');
            if (sessionUser && sessionPass) {
                username = sessionUser;
                password = sessionPass;
                found = true;
            }
        } catch (e) {}
    }
    
    if (found) {
        setTimeout(function() {
            authenticateWidget(username, password);
        }, 2000);
    }
    
    return found;
}

function authenticateWidget(username, password) {
    var attempts = 0;
    var maxAttempts = 10;
    
    var authInterval = setInterval(function() {
        attempts++;
        
        var forms = document.querySelectorAll('form');
        var authenticated = false;
        
        forms.forEach(function(form, index) {
            var usernameField = form.querySelector('input[type="text"], input[type="email"], input[name*="user"], input[name*="login"]');
            var passwordField = form.querySelector('input[type="password"], input[name*="pass"]');
            var submitButton = form.querySelector('input[type="submit"], button[type="submit"], button');
            
            if (usernameField && passwordField && !usernameField.value) {
                usernameField.value = username;
                passwordField.value = password;
                
                ['input', 'change', 'keyup', 'blur'].forEach(function(eventType) {
                    usernameField.dispatchEvent(new Event(eventType, {bubbles: true}));
                    passwordField.dispatchEvent(new Event(eventType, {bubbles: true}));
                });
                
                setTimeout(function() {
                    if (submitButton) {
                        submitButton.click();
                    }
                    if (form.submit) {
                        form.submit();
                    }
                }, 300);
                
                authenticated = true;
            }
        });
        
        if (authenticated || attempts >= maxAttempts) {
            clearInterval(authInterval);
        }
    }, 1000);
}

// Listen for authentication messages
window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'mmvcs_auth' && event.data.username) {
        console.log('Sales Comparison received authentication for:', event.data.username);
        setTimeout(function() {
            authenticateWidget(event.data.username, event.data.password);
        }, 1000);
    }
});

// Also set up parent window message relay
if (window.parent && window.parent !== window) {
    try {
        window.parent.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'mmvcs_auth') {
                // Re-broadcast to this window
                window.postMessage(event.data, '*');
                console.log('Sales Comparison received auth via parent relay');
            }
        });
    } catch(e) {
        console.log('Could not set up parent message relay:', e.message);
    }
}

// Start checking for credentials - but only check for fresh auth
setTimeout(function() {
    // Don't auto-load with stored credentials - wait for fresh auth message
    console.log('Sales Comparison ready - waiting for authentication');
    
    // Poll for authentication data in parent window global variable
    var globalPollCount = 0;
    var sessionId = Date.now();
    
    var globalPollInterval = setInterval(function() {
        globalPollCount++;
        
        try {
            // Check for auth data in parent window
            if (window.parent && window.parent.mmvcs_current_auth) {
                var authData = window.parent.mmvcs_current_auth;
                if (authData.username && authData.timestamp > (sessionId - 60000)) { // Within last minute
                    console.log('Sales Comparison found auth in parent global');
                    clearInterval(globalPollInterval);
                    authenticateWidget(authData.username, authData.password);
                    return;
                }
            }
        } catch(e) {}
        
        try {
            // Check for auth data in top window
            if (window.top && window.top.mmvcs_current_auth) {
                var authData = window.top.mmvcs_current_auth;
                if (authData.username && authData.timestamp > (sessionId - 60000)) { // Within last minute
                    console.log('Sales Comparison found auth in top global');
                    clearInterval(globalPollInterval);
                    authenticateWidget(authData.username, authData.password);
                    return;
                }
            }
        } catch(e) {}
        
        if (globalPollCount > 30) { // Stop polling after 30 attempts (1.5 minutes)
            clearInterval(globalPollInterval);
            console.log('Sales Comparison stopped polling for auth after 30 attempts');
        }
    }, 3000);
}, 1000);
</script>
</body>
</html>