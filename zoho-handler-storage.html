<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Auth Status</title>
</head>
<body style="margin:0;padding:10px;font-family:Arial,sans-serif;font-size:12px;background:#f8f9fa;">
<div style="text-align:center;">üîê Authentication Status</div>
<div id="status" style="margin-top:10px;padding:8px;border-radius:4px;background:white;border:1px solid #ddd;"></div>
<script>
var statusDiv = document.getElementById('status');

function updateStatus(message, color) {
    statusDiv.innerHTML = message;
    statusDiv.style.color = color || '#333';
    console.log('Auth Status:', message);
}

function checkCredentials() {
    var found = false;
    var username = '';
    var password = '';
    var source = '';
    
    // Check localStorage
    try {
        var localUser = localStorage.getItem('mmvcs_user');
        var localPass = localStorage.getItem('mmvcs_pass');
        if (localUser && localPass) {
            username = localUser;
            password = localPass;
            source = 'localStorage';
            found = true;
        }
    } catch(e) {}
    
    // Check sessionStorage
    if (!found) {
        try {
            var sessionUser = sessionStorage.getItem('mmvcs_user');
            var sessionPass = sessionStorage.getItem('mmvcs_pass');
            if (sessionUser && sessionPass) {
                username = sessionUser;
                password = sessionPass;
                source = 'sessionStorage';
                found = true;
            }
        } catch(e) {}
    }
    
    // Check parent window
    if (!found) {
        try {
            if (window.parent && window.parent.mmvcs_credentials) {
                var creds = window.parent.mmvcs_credentials;
                username = creds.username;
                password = creds.password;
                source = 'parent window';
                found = true;
            }
        } catch(e) {}
    }
    
    // Check top window
    if (!found) {
        try {
            if (window.top && window.top.mmvcs_credentials) {
                var creds = window.top.mmvcs_credentials;
                username = creds.username;
                password = creds.password;
                source = 'top window';
                found = true;
            }
        } catch(e) {}
    }
    
    if (found) {
        updateStatus('‚úì Found credentials for: ' + username + '<br><small>Source: ' + source + '</small>', 'green');
        
        // Now authenticate other widgets
        setTimeout(function() {
            authenticateWidgets(username, password);
        }, 1000);
        
        return true;
    } else {
        updateStatus('‚è≥ Waiting for login credentials...', '#666');
        return false;
    }
}

function authenticateWidgets(username, password) {
    updateStatus('üîÑ Broadcasting authentication...', 'blue');
    
    // Store credentials in multiple global locations for other widgets to find
    try {
        // Try to store in parent window
        if (window.parent && window.parent !== window) {
            window.parent.mmvcs_auth_broadcast = {
                username: username,
                password: password,
                timestamp: Date.now(),
                source: 'handler'
            };
        }
    } catch (e) {}
    
    try {
        // Try to store in top window
        if (window.top && window.top !== window) {
            window.top.mmvcs_auth_broadcast = {
                username: username,
                password: password,
                timestamp: Date.now(),
                source: 'handler'
            };
        }
    } catch (e) {}
    
    // Since we can't directly access other iframes, try broadcasting via wildcard postMessage
    try {
        // Send to parent window with wildcard
        window.parent.postMessage({
            type: 'mmvcs_global_auth',
            username: username,
            password: password,
            broadcast: true
        }, '*');
        
        // Send to top window with wildcard  
        window.top.postMessage({
            type: 'mmvcs_global_auth',
            username: username,
            password: password,
            broadcast: true
        }, '*');
        
        updateStatus('üì° Broadcasting via parent/top windows...', 'blue');
        
    } catch (e) {
        console.log('Could not broadcast via parent:', e.message);
    }
    
    // Try sending to known Caspio domains
    var caspioOrigins = [
        'https://c0acv999.caspio.com',
        'https://caspio.com',
        '*'
    ];
    
    caspioOrigins.forEach(function(origin) {
        try {
            window.postMessage({
                type: 'caspio_global_auth',
                username: username,
                password: password,
                targetOrigin: origin
            }, origin);
        } catch (e) {}
    });
    
    // Create a polling system to keep broadcasting
    var broadcastCount = 0;
    var maxBroadcasts = 10;
    
    var broadcastInterval = setInterval(function() {
        broadcastCount++;
        
        if (broadcastCount > maxBroadcasts) {
            clearInterval(broadcastInterval);
            updateStatus('‚úÖ Broadcasting complete (' + maxBroadcasts + ' attempts)', 'green');
            return;
        }
        
        // Keep updating the global auth data
        try {
            window.parent.mmvcs_current_auth = {
                username: username,
                password: password,
                timestamp: Date.now(),
                attempt: broadcastCount
            };
            
            window.top.mmvcs_current_auth = {
                username: username,
                password: password,
                timestamp: Date.now(),
                attempt: broadcastCount
            };
        } catch (e) {}
        
        updateStatus('üì° Broadcasting attempt ' + broadcastCount + '/' + maxBroadcasts, 'blue');
        
    }, 2000);
}

// Check for credentials every 2 seconds
updateStatus('üîç Scanning for credentials...', '#666');

var checkInterval = setInterval(function() {
    if (checkCredentials()) {
        // Found credentials, reduce checking frequency
        clearInterval(checkInterval);
        setInterval(checkCredentials, 10000); // Check every 10 seconds
    }
}, 2000);
</script>
</body>
</html>