<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMVCS Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>MMVCS Dashboard</h1>
        </header>
        
        <main class="dashboard-main">
            <div class="widgets-grid">
                <div class="widget-container full-width welcome-widget">
                    <h3></h3>
                    <div class="widget-frame">
                        <script type="text/javascript" src="https://c0acv999.caspio.com/dp/01217000f2c3610f806e481a9264/emb"></script>
                    </div>
                </div>

                <div class="widget-container full-width">
                    <h3>Sales Comparison This Year vs. Last Year</h3>
                    <div class="widget-frame">
                        <script type="text/javascript" src="https://c0acv999.caspio.com/dp/01217000201cfed888f24342b18f/emb"></script>
                    </div>
                </div>

                <div class="widget-container full-width">
                    <h3>Sales Chart by Month</h3>
                    <div class="widget-frame">
                        <script type="text/javascript" src="https://c0acv999.caspio.com/dp/0121700013fadbf0a2db4aca8f73/emb"></script>
                    </div>
                </div>

                <div class="widget-container">
                    <h3>Destination Mix - Current Year</h3>
                    <div class="widget-frame">
                        <script type="text/javascript" src="https://c0acv999.caspio.com/dp/01217000564ddc00d2ab4c7aac4d/emb"></script>
                    </div>
                </div>

                <div class="widget-container">
                    <h3>Destination Mix - Last Year</h3>
                    <div class="widget-frame">
                        <script type="text/javascript" src="https://c0acv999.caspio.com/dp/01217000301880de360842d1adb1/emb"></script>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check for authentication credentials in URL
            const urlParams = new URLSearchParams(window.location.search);
            const authParam = urlParams.get('auth');
            
            if (authParam) {
                try {
                    // Decode credentials from URL
                    const decoded = atob(decodeURIComponent(authParam));
                    const [username, password] = decoded.split(':');
                    
                    if (username && password) {
                        // Store credentials for widget authentication
                        sessionStorage.setItem('mmvcs_user', username);
                        sessionStorage.setItem('mmvcs_password', password);
                        sessionStorage.setItem('auto_auth', 'true');
                        
                        // Clean URL to remove credentials
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        console.log('Starting auto-authentication with:', username);
                        
                        // Wait longer for all widgets to load, then authenticate
                        setTimeout(() => {
                            autoAuthenticateAllWidgets(username, password);
                        }, 2000);
                        
                        setTimeout(() => {
                            autoAuthenticateAllWidgets(username, password);
                        }, 4000);
                        
                        setTimeout(() => {
                            autoAuthenticateAllWidgets(username, password);
                        }, 6000);
                    }
                } catch (error) {
                    console.error('Error processing authentication:', error);
                }
            }
        });

        function autoAuthenticateAllWidgets(username, password) {
            console.log('AUTO-AUTH: Starting with username:', username);
            
            // Find all Caspio widgets
            const widgets = document.querySelectorAll('.widget-frame');
            console.log('AUTO-AUTH: Found', widgets.length, 'widgets');
            
            let authAttempts = 0;
            const maxAttempts = 30; // More attempts for multiple widgets
            
            const attemptAuth = () => {
                let authenticatedCount = 0;
                
                widgets.forEach((widget, index) => {
                    // Look for iframes within each widget
                    const iframe = widget.querySelector('iframe');
                    
                    if (iframe) {
                        console.log('AUTO-AUTH: Found iframe in widget', index);
                        authenticateIframe(iframe, username, password, index);
                        authenticatedCount++;
                    }
                });
                
                authAttempts++;
                
                // Keep trying until we find widgets to authenticate or max attempts
                if (authenticatedCount === 0 && authAttempts < maxAttempts) {
                    setTimeout(attemptAuth, 1000);
                }
            };
            
            attemptAuth();
        }

        function authenticateIframe(iframe, username, password, widgetIndex) {
            try {
                setTimeout(() => {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        
                        // Look for login form in iframe
                        const usernameField = iframeDoc.querySelector('input[type="text"], input[name*="user"], input[name*="login"]');
                        const passwordField = iframeDoc.querySelector('input[type="password"], input[name*="pass"]');
                        const submitButton = iframeDoc.querySelector('input[type="submit"], button[type="submit"], button');
                        
                        if (usernameField && passwordField && submitButton) {
                            console.log(`AUTO-AUTH: Found login form in widget ${widgetIndex}, filling...`);
                            
                            // Fill credentials
                            usernameField.value = username;
                            passwordField.value = password;
                            
                            // Trigger events to ensure form recognizes the values
                            ['input', 'change', 'keyup', 'blur'].forEach(eventType => {
                                usernameField.dispatchEvent(new Event(eventType, { bubbles: true }));
                                passwordField.dispatchEvent(new Event(eventType, { bubbles: true }));
                            });
                            
                            // Wait a moment then submit
                            setTimeout(() => {
                                submitButton.click();
                                console.log(`AUTO-AUTH: Submitted widget ${widgetIndex} form`);
                            }, 1500); // Longer delay for stability
                        }
                    } catch (crossOriginError) {
                        // Try postMessage for cross-origin iframes
                        iframe.contentWindow.postMessage({
                            type: 'caspio_auto_auth',
                            username: username,
                            password: password
                        }, '*');
                        
                        console.log(`AUTO-AUTH: Sent postMessage to widget ${widgetIndex} cross-origin iframe`);
                    }
                }, 1000 + (widgetIndex * 500)); // Stagger authentication attempts
            } catch (error) {
                console.log(`Error authenticating widget ${widgetIndex} iframe:`, error);
            }
        }

        // Show authentication status after processing
        setTimeout(() => {
            if (sessionStorage.getItem('auto_auth') === 'true') {
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = `
                    position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; 
                    padding: 15px; border-radius: 5px; z-index: 10000; max-width: 300px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                `;
                statusDiv.innerHTML = `
                    ✅ <strong>Auto-authenticated</strong><br>
                    Credentials applied to all widgets
                    <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: white; cursor: pointer; font-size: 16px;">×</button>
                `;
                document.body.appendChild(statusDiv);
                
                setTimeout(() => {
                    if (document.body.contains(statusDiv)) {
                        document.body.removeChild(statusDiv);
                    }
                }, 8000);
                
                sessionStorage.removeItem('auto_auth');
            }
        }, 3000);
    </script>
</body>
</html>