<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MMVCS Dashboard</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
.header { text-align: center; margin-bottom: 30px; }
.widgets-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1400px; margin: 0 auto; }
.widget-box { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-height: 400px; }
.widget-box h3 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
.full-width { grid-column: span 2; }
.status { font-size: 12px; color: #666; margin-bottom: 10px; }
.widget-content { min-height: 350px; }
</style>
</head>
<body>
<div class="header">
    <h1>MMVCS Dashboard</h1>
    <p>All your widgets in one place</p>
</div>

<div class="widgets-grid">
    <div class="widget-box full-width">
        <h3>Welcome Dashboard</h3>
        <div class="status" id="status-welcome">Loading widget...</div>
        <div class="widget-content" id="welcome-widget"></div>
    </div>
    
    <div class="widget-box">
        <h3>Sales Comparison</h3>
        <div class="status" id="status-sales">Loading widget...</div>
        <div class="widget-content" id="sales-widget"></div>
    </div>
    
    <div class="widget-box">
        <h3>Sales Chart</h3>
        <div class="status" id="status-chart">Loading widget...</div>
        <div class="widget-content" id="chart-widget"></div>
    </div>
    
    <div class="widget-box">
        <h3>Destination Mix - Current</h3>
        <div class="status" id="status-current">Loading widget...</div>
        <div class="widget-content" id="current-widget"></div>
    </div>
    
    <div class="widget-box">
        <h3>Destination Mix - Last Year</h3>
        <div class="status" id="status-last">Loading widget...</div>
        <div class="widget-content" id="last-widget"></div>
    </div>
</div>

<script>
// Check for credentials
const username = localStorage.getItem('mmvcs_user');
const password = localStorage.getItem('mmvcs_pass');

if (!username || !password) {
    alert('Please login first');
    window.location.href = 'simple-login.html';
}

// Widget configurations
const widgets = [
    { id: 'welcome-widget', statusId: 'status-welcome', src: 'https://c0acv999.caspio.com/dp/01217000f2c3610f806e481a9264/emb', name: 'Welcome' },
    { id: 'sales-widget', statusId: 'status-sales', src: 'https://c0acv999.caspio.com/dp/01217000201cfed888f24342b18f/emb', name: 'Sales Comparison' },
    { id: 'chart-widget', statusId: 'status-chart', src: 'https://c0acv999.caspio.com/dp/0121700013fadbf0a2db4aca8f73/emb', name: 'Sales Chart' },
    { id: 'current-widget', statusId: 'status-current', src: 'https://c0acv999.caspio.com/dp/01217000564ddc00d2ab4c7aac4d/emb', name: 'Current Mix' },
    { id: 'last-widget', statusId: 'status-last', src: 'https://c0acv999.caspio.com/dp/01217000301880de360842d1adb1/emb', name: 'Last Year Mix' }
];

function updateStatus(statusId, message) {
    document.getElementById(statusId).textContent = message;
}

function authenticateWidget(widgetName) {
    console.log(`Starting authentication for ${widgetName}`);
    
    let attempts = 0;
    const maxAttempts = 30; // Increased attempts
    
    const checkForForms = setInterval(() => {
        attempts++;
        const forms = document.querySelectorAll('form');
        
        console.log(`${widgetName} - Attempt ${attempts}: Found ${forms.length} total forms on page`);
        
        let authenticated = false;
        
        forms.forEach((form, index) => {
            // More comprehensive field detection
            const userField = form.querySelector('input[type="text"]:not([readonly]):not([disabled]), input[type="email"], input[name*="user"], input[name*="login"], input[name*="User"], input[name*="Login"], input[id*="user"], input[id*="login"]');
            const passField = form.querySelector('input[type="password"]:not([readonly]):not([disabled])');
            const submitBtn = form.querySelector('input[type="submit"], button[type="submit"], button:not([type]), input[value*="Login"], input[value*="login"], input[value*="Submit"], input[value*="submit"]');
            
            console.log(`${widgetName} - Form ${index}: User field: ${!!userField}, Pass field: ${!!passField}, Submit: ${!!submitBtn}`);
            
            if (userField && passField && !userField.value) {
                console.log(`${widgetName} - Filling form ${index} with credentials`);
                
                userField.focus();
                userField.value = username;
                passField.focus();
                passField.value = password;
                
                // Trigger multiple events to ensure form recognizes input
                [userField, passField].forEach(field => {
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                    field.dispatchEvent(new Event('keyup', { bubbles: true }));
                    field.dispatchEvent(new Event('blur', { bubbles: true }));
                });
                
                setTimeout(() => {
                    if (submitBtn) {
                        submitBtn.focus();
                        submitBtn.click();
                        console.log(`${widgetName} - Clicked submit button`);
                    } else {
                        form.submit();
                        console.log(`${widgetName} - Submitted form directly`);
                    }
                }, 1000);
                
                authenticated = true;
            }
        });
        
        if (authenticated) {
            clearInterval(checkForForms);
            console.log(`${widgetName} - Authentication submitted successfully`);
        } else if (attempts >= maxAttempts) {
            clearInterval(checkForForms);
            console.log(`${widgetName} - Max attempts reached, no forms found`);
        }
    }, 2000); // Check every 2 seconds
}

// Load widgets with staggered timing to avoid conflicts
widgets.forEach((widget, index) => {
    setTimeout(() => {
        updateStatus(widget.statusId, 'Loading Caspio widget...');
        
        // Load the widget
        const container = document.getElementById(widget.id);
        container.innerHTML = `<script src="${widget.src}"><\/script>`;
        
        // Start authentication after widget loads
        setTimeout(() => {
            updateStatus(widget.statusId, 'Authenticating...');
            authenticateWidget(widget.name);
        }, 5000 + (index * 2000)); // Stagger authentication
        
    }, index * 3000); // Stagger widget loading
});
</script>
</body>
</html>