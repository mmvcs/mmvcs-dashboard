<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sales Comparison Widget</title>
<style>
body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
</style>
</head>
<body>

<iframe src="https://c0acv999.caspio.com/dp/01217000201cfed888f24342b18f" 
        width="100%" height="600" frameborder="0" scrolling="auto">
</iframe>

<script>
// Auto-authentication when credentials are available
function autoAuthenticate() {
    try {
        var username = localStorage.getItem('mmvcs_user');
        var password = localStorage.getItem('mmvcs_pass');
        
        // Try parent storage as fallback
        if (!username || !password) {
            try {
                username = window.parent.localStorage.getItem('mmvcs_user');
                password = window.parent.localStorage.getItem('mmvcs_pass');
            } catch (e) {
                console.log('Cannot access parent storage:', e);
            }
        }
        
        if (username && password) {
            console.log('Attempting Caspio authentication with user:', username);
            
            // Try multiple times with different delays
            var delays = [500, 1500, 3000, 5000];
            
            delays.forEach(function(delay) {
                setTimeout(function() {
                    // Try to find forms in this document first
                    var forms = document.querySelectorAll('form');
                    console.log('Found', forms.length, 'forms in main Caspio widget at delay', delay);
                    
                    // Also try to access forms in the nested iframe
                    var caspioIframe = document.querySelector('iframe');
                    if (caspioIframe) {
                        try {
                            var iframeDoc = caspioIframe.contentDocument || caspioIframe.contentWindow.document;
                            var iframeForms = iframeDoc.querySelectorAll('form');
                            console.log('Found', iframeForms.length, 'forms in nested Caspio iframe at delay', delay);
                            
                            // Process iframe forms
                            iframeForms.forEach(function(form, index) {
                                var userField = form.querySelector('input[type="text"], input[name*="user"], input[name*="login"], input[placeholder*="user"], input[placeholder*="User"]');
                                var passField = form.querySelector('input[type="password"]');
                                var submitBtn = form.querySelector('input[type="submit"], button[type="submit"], button, input[value*="Login"], input[value*="login"]');
                                
                                console.log('Nested Caspio form', index, '- User field:', !!userField, 'Pass field:', !!passField, 'Submit:', !!submitBtn);
                                
                                if (userField && passField) {
                                    userField.value = username;
                                    passField.value = password;
                                    
                                    // Trigger events
                                    userField.dispatchEvent(new Event('change', { bubbles: true }));
                                    userField.dispatchEvent(new Event('input', { bubbles: true }));
                                    passField.dispatchEvent(new Event('change', { bubbles: true }));
                                    passField.dispatchEvent(new Event('input', { bubbles: true }));
                                    
                                    console.log('Filled nested Caspio form', index, 'with credentials');
                                    
                                    setTimeout(function() {
                                        if (submitBtn) {
                                            submitBtn.click();
                                            console.log('Clicked nested Caspio submit button for form', index);
                                        } else {
                                            form.submit();
                                            console.log('Submitted nested Caspio form', index, 'directly');
                                        }
                                    }, 300);
                                }
                            });
                        } catch (e) {
                            console.log('Cannot access nested Caspio iframe at delay', delay, ':', e);
                        }
                    }
                    
                    // Process main document forms
                    forms.forEach(function(form, index) {
                        var userField = form.querySelector('input[type="text"], input[name*="user"], input[name*="login"], input[placeholder*="user"], input[placeholder*="User"]');
                        var passField = form.querySelector('input[type="password"]');
                        var submitBtn = form.querySelector('input[type="submit"], button[type="submit"], button, input[value*="Login"], input[value*="login"]');
                        
                        console.log('Main Caspio form', index, '- User field:', !!userField, 'Pass field:', !!passField, 'Submit:', !!submitBtn);
                        
                        if (userField && passField) {
                            userField.value = username;
                            passField.value = password;
                            
                            // Trigger events
                            userField.dispatchEvent(new Event('change', { bubbles: true }));
                            userField.dispatchEvent(new Event('input', { bubbles: true }));
                            passField.dispatchEvent(new Event('change', { bubbles: true }));
                            passField.dispatchEvent(new Event('input', { bubbles: true }));
                            
                            console.log('Filled main Caspio form', index, 'with credentials');
                            
                            setTimeout(function() {
                                if (submitBtn) {
                                    submitBtn.click();
                                    console.log('Clicked main Caspio submit button for form', index);
                                } else {
                                    form.submit();
                                    console.log('Submitted main Caspio form', index, 'directly');
                                }
                            }, 300);
                        }
                    });
                }, delay);
            });
        } else {
            console.log('No credentials available for Caspio authentication');
        }
    } catch (e) {
        console.log('Caspio authentication error:', e);
    }
}

// Listen for authentication messages from parent wrapper
window.addEventListener('message', function(event) {
    console.log('Caspio widget received message:', event.data);
    if (event.data && event.data.type === 'mmvcs_auth') {
        console.log('Processing authentication message with user:', event.data.username);
        localStorage.setItem('mmvcs_user', event.data.username);
        localStorage.setItem('mmvcs_pass', event.data.password);
        
        // Also forward the message to the nested Caspio iframe
        var caspioIframe = document.querySelector('iframe');
        if (caspioIframe && caspioIframe.contentWindow) {
            try {
                caspioIframe.contentWindow.postMessage(event.data, '*');
                console.log('Forwarded auth message to nested Caspio iframe');
            } catch (e) {
                console.log('Could not forward to nested iframe:', e);
            }
        }
        
        autoAuthenticate();
    }
});

// Auto-authenticate on load
setTimeout(autoAuthenticate, 2000);

// Also check for credentials every 2 seconds
setInterval(function() {
    var username = localStorage.getItem('mmvcs_user');
    if (username) {
        console.log('Found stored credentials, attempting authentication...');
        autoAuthenticate();
    }
}, 2000);
</script>
</body>
</html>