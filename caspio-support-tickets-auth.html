<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Support Tickets (Auto-Auth)</title>
<style>
body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
#auth-indicator { 
    position: fixed; 
    top: 5px; 
    right: 5px; 
    background: #f0f8ff; 
    padding: 5px 10px; 
    border-radius: 3px; 
    font-size: 11px; 
    border: 1px solid #ccc;
    z-index: 1000;
}
#caspio-container { width: 100%; height: 100vh; }
</style>
</head>
<body>
<div id="auth-indicator">üîç Checking auth...</div>
<div id="caspio-container">
    <script type="text/javascript" src="https://c0acv999.caspio.com/dp/01217000b3314ae88b7949d3bc8d/emb"></script>
</div>

<script>
var authIndicator = document.getElementById('auth-indicator');

function updateIndicator(message, color) {
    authIndicator.innerHTML = message;
    authIndicator.style.color = color || '#333';
    console.log('Support Tickets Auth:', message);
}

function checkForCredentials() {
    var username = '';
    var password = '';
    var found = false;
    
    // Check localStorage
    try {
        var localUser = localStorage.getItem('mmvcs_user');
        var localPass = localStorage.getItem('mmvcs_pass');
        if (localUser && localPass) {
            username = localUser;
            password = localPass;
            found = true;
            updateIndicator('üîê Found stored auth', 'green');
        }
    } catch (e) {}
    
    // Check sessionStorage
    if (!found) {
        try {
            var sessionUser = sessionStorage.getItem('mmvcs_user');
            var sessionPass = sessionStorage.getItem('mmvcs_pass');
            if (sessionUser && sessionPass) {
                username = sessionUser;
                password = sessionPass;
                found = true;
                updateIndicator('üîê Found session auth', 'green');
            }
        } catch (e) {}
    }
    
    if (found) {
        setTimeout(function() {
            authenticateWidget(username, password);
        }, 2000); // Wait for Caspio widget to load
    } else {
        updateIndicator('‚è≥ Waiting for auth...', '#666');
    }
    
    return found;
}

function authenticateWidget(username, password) {
    updateIndicator('üîÑ Authenticating...', 'blue');
    
    var attempts = 0;
    var maxAttempts = 20; // Increased attempts for slower loading widgets
    
    var authInterval = setInterval(function() {
        attempts++;
        
        // Look for login forms that may have appeared
        var forms = document.querySelectorAll('form');
        var authenticated = false;
        
        updateIndicator('üîÑ Attempt ' + attempts + '/20...', 'blue');
        
        forms.forEach(function(form, index) {
            var usernameField = form.querySelector('input[type="text"], input[type="email"], input[name*="user"], input[name*="login"]');
            var passwordField = form.querySelector('input[type="password"], input[name*="pass"]');
            var submitButton = form.querySelector('input[type="submit"], button[type="submit"], button');
            
            if (usernameField && passwordField && !usernameField.value) {
                // Fill the form
                usernameField.value = username;
                passwordField.value = password;
                
                // Trigger events
                ['input', 'change', 'keyup', 'blur'].forEach(function(eventType) {
                    usernameField.dispatchEvent(new Event(eventType, {bubbles: true}));
                    passwordField.dispatchEvent(new Event(eventType, {bubbles: true}));
                });
                
                // Submit the form
                setTimeout(function() {
                    if (submitButton) {
                        submitButton.click();
                    }
                    if (form.submit) {
                        form.submit();
                    }
                    
                    // After submitting, wait and try to reload if needed
                    setTimeout(function() {
                        checkIfNeedsReload();
                    }, 2000);
                    
                }, 300);
                
                authenticated = true;
                updateIndicator('‚úÖ Form authenticated', 'green');
                console.log('Authenticated form in Support Tickets widget');
            }
        });
        
        if (authenticated || attempts >= maxAttempts) {
            clearInterval(authInterval);
            if (!authenticated) {
                updateIndicator('‚Ñπ No login form found', '#999');
            }
        }
    }, 1500); // Slower checking interval
}

function checkIfNeedsReload() {
    // Check if the widget shows any error or login required message
    var bodyText = document.body.innerText.toLowerCase();
    var needsReload = bodyText.includes('login') || 
                      bodyText.includes('authentication') || 
                      bodyText.includes('error') ||
                      bodyText.includes('access denied');
    
    if (needsReload) {
        updateIndicator('üîÑ Auto-refreshing...', 'orange');
        setTimeout(function() {
            location.reload();
        }, 1000);
    } else {
        updateIndicator('‚úÖ Widget loaded', 'green');
    }
}

// Listen for authentication messages
window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'mmvcs_auth' && event.data.username) {
        console.log('Received auth message:', event.data);
        updateIndicator('üì® Received auth message', 'blue');
        setTimeout(function() {
            authenticateWidget(event.data.username, event.data.password);
        }, 1000);
    }
});

// Start checking for credentials
setTimeout(function() {
    if (!checkForCredentials()) {
        // No credentials found, check periodically
        setInterval(checkForCredentials, 3000);
    }
}, 1000);

console.log('Support Tickets authentication wrapper loaded');
</script>
</body>
</html>